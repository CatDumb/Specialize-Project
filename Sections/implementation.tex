%
% This is the TeX file for the implementation section
%
\section{IMPLEMENTATION}
\label{section:implementation}

\subsection{Bus Services Integration}

\subsubsection{Getting a single route's information}

The integrity of the data on the Buyt TPHCM website is guaranteed due to its commissioning and maintenance by the Ho Chi Minh City Department of Transport. 

Several JavaScript source files power this site:
\begin{itemize}
    \item \textbf{L.Config.js:} This is a configuration file to set up the map rendering for Buyt TPHCM. The tiles are loaded from http://map.stis.vn/bright/{z}/{x}/{y}.png.
    \item \textbf{L.RouteMap.js:} This source file is responsible for showing the stops and bus routes. We were able to get the coordinate sets that we wanted by placing breakpoints on this file.
\end{itemize}

\begin{figure}[H]
    \includegraphics[width=\textwidth]{assets/images/Research/Bus/lat_long_web.png}
    \caption{Capturing and observing the route data using the DevTool}
    \label{fig:lat_long_web}
\end{figure}

By inserting breakpoints in L.RouteMap.js, we can easily obtain the coordinates of the route, as demonstrated on the right-hand side. It is worth mentioning that while the coordinates are given in both distinct arrays and a single array with integrated data, it is more advantageous to utilize the latitudes and longitudes in separate arrays. The reason for this is that the present system implementation utilizes MongoDB, which does not allow tuples due to its implementation of BSON.

When it is desirable to work with a single array of coordinates, the stored data can be retrieved and combined together. Below is an example where we zip the arrays and plot them using Matplotlib (please note that since there are over 600 elements in each array, 668 to be exact, a figurative number was put in the code excerpt)

\begin{lstlisting}[language=python]
    lat = [10.001, 10.002] # the latitudes
    lng = [106.001, 106.002] # the longitudes
    coordinates = [(lat[i], lng[i]) for i in range(min(len(lat), len(lng)))]
    # Extract latitudes and longitudes from the coordinates
    latitudes, longitudes = zip(*coordinates)
    
    # Create a scatter plot to mark the coordinates
    plt.scatter(longitudes, latitudes, color='red', marker='o', label='Coordinates')
    
    # Create a line plot to draw the polyline
    plt.plot(longitudes, latitudes, color='blue', label='Polyline')
    
    # Set labels for the x and y axes
    plt.xlabel('Longitude')
    plt.ylabel('Latitude')
    
    # Add a legend
    plt.legend()
    
    # Display the plot
    plt.show()
\end{lstlisting}

The result is as follow:
\begin{figure}[H]
    \centering
    \subfloat[The Matplotlib representation of the bus route 8.]{
        \includegraphics[width=0.4\linewidth]{assets/images/Research/Bus/plot_route.png}
        \label{fig:plot-route}
    }
    \hspace{0.5cm} % Add a horizontal space of 0.5 cm
    \subfloat[The actual route 8 from Buyt TPHCM.]{
        \includegraphics[width=0.4\linewidth]{assets/images/Research/Bus/actual_route.png}
        \label{fig:actual_route}
    }
\end{figure}

Similarly, information about the bus stops can be obtained by placing breakpoints in L.RouteMap.js. Each route comes with a list of stops and their corresponding data. This will be useful in designing our data schema later on when we integrate the gathered information into our database.

\begin{figure}[H]
    \includegraphics[width=\textwidth]{assets/images/Research/Bus/stop_web.png}
    \caption{Capturing and observing the bus stops data using the DevTool}
    \label{fig:stop_data}
\end{figure}

\subsubsection{Automation of the mining process}

Since there are about 130 routes currently displayed on the website, it is impossible to place breakpoints and collect data by hand. This necessitates the use of automatic scripts to gather information.

After careful examination, we found several places where we could mine the data. This introduces us to the routevar.js file, which contains the three functions: loadVarsByRou(rouId), loadStopsByVar(prtId, rouId, varId), and loadPathByVar(prtId, rouId, varId)

\subsubsection{Data storage of bus services}

\subsection{Bus API Development and Server Deployment}
We have previously discussed the introduction of the API additions in the UTraffic system, and we have taken the steps to deploy them on the live server of UTraffic. The endpoints are now live and working as intended.
\subsubsection{The Bus API}
The following are the details of the new API endpoints. An example URL and the corresponding response are also provided for each endpoint.

\begin{itemize}
    
    \item \textbf{Get nearby bus stops}.
    
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/nearby-stops}.
        \item Query parameters: \lstinline{lat}, \lstinline{lng}, \lstinline{radius}.
        \item Example request URL: \url{https://api.bktraffic.com/api/bus/nearby-stops?lat=10.7721&lng=106.6579&radius=500}
        \item Example response: 
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\linewidth]{assets/images/Implementation/nearby_bus_response.png}
            \caption{The response containing bus stops within 500m of the coordinate (10.7721, 106.6579).}
            \label{fig:nearby_stop_response}
        \end{figure}
    \end{itemize}

    \item \textbf{Get nearby disability friendly bus stops}.
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/disability-friendly-stops}.
        \item Query parameters: \lstinline{lat}, \lstinline{lng}.
        \item Example request URL: \url{http://api.bktraffic.com/api/bus/disability-friendly-stops?lat=10.77037&lng=106.69868}
        \item Example response:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\textwidth]{assets/images/Implementation/nearby_disable_response.png}
            \caption{The response containing bus stops that are disability-friendly near the coordinate (10.77037, 106.69868).}
            \label{fig:nearby_disable_response}
        \end{figure}
    \end{itemize}

    \item \textbf{Get the details of a bus stop}.
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/stop-details}.
        \item Query parameters: \lstinline{id}.
        \item Example request URL: \url{https://api.bktraffic.com/api/bus/stop-details?id=2931}.
        \item Example response:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\textwidth]{assets/images/Implementation/stop_detail_response.png}
            \caption{The response containing the details of the bus stop with the ID 2931.}
            \label{fig:stop_detail_response}
        \end{figure}
    \end{itemize}

    \item \textbf{Get all bus routes}.
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/routes}.
        \item Query paramaters: none.
        \item Example request URL: \url{https://api.bktraffic.com/api/bus/routes}.
        \item Example response:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\textwidth]{assets/images/Implementation/all_routes_response.png}
            \caption{The response containing all the bus routes of Ho Chi Minh City.}
            \label{fig:all_routes_response}
        \end{figure}
    \end{itemize}

    \item \textbf{Get the details of a bus route}.
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/route-details}.
        \item Query parameters: \lstinline{id}.
        \item Example request URL: \url{http://api.bktraffic.com/api/bus/route-info?id=08}
        \item Example response:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.4\textwidth]{assets/images/Implementation/route_details_response.png}
            \caption{The response containing the details of the bus route with the ID 08.}
            \label{fig:route_details_response}
        \end{figure}
    \end{itemize}

    \item \textbf{Get the bus stops along a bus route's path}.
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/route-stops}.
        \item Query parameters: \lstinline{id}, \lstinline{leg}.
        \item Example request URL: \url{https://api.bktraffic.com/api/bus/route-stops?id=08&leg=forward}.
        \item Example response:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.4\textwidth]{assets/images/Implementation/route_stops_response.png}
            \caption{The response containing the array of the bus stop IDs along the route 08.}
            \label{fig:route_stops_response}
        \end{figure}
    \end{itemize}

    \item \textbf{Get the path of a bus route}.
    \begin{itemize}
        \item URL: \url{https://api.bktraffic.com/api/bus/route-path}.
        \item Query paramaters: \lstinline{id}, \lstinline{leg}.
        \item Example request URL: \url{https://api.bktraffic.com/api/bus/route-path?id=08&leg=forward}.
        \item Example response:
        \begin{figure}[H]
            \centering
            \includegraphics[width=0.5\textwidth]{assets/images/Implementation/route_path_response.png}
            \caption{The response containing the line string path of the bus route 08.}
            \label{fig:route_path_response}
        \end{figure}
    \end{itemize} 
\end{itemize}

\subsubsection{Deployment of the Bus API}
The deployment process was made possible first by accessing the server via the SSH protocol. The server is running Ubuntu 20.04 LTS with the NodeJS version 12.22.12 installed. It was crucial to first upgrade this NodeJS version to a more recent one due to this version being out of the active support. We have upgraded the NodeJS version to version 16.16.0 (LTS) instead of the newer version 18 or above, because the server hardware is also not very powerful, and the newer versions of NodeJS are not compatible. We also noticed that there was no Node Version Manager (NVM) installed on the server. This is a tool that allows us to install and manage multiple versions of NodeJS on the same machine, therefore, we installed the new node version with NVM.

The next step was to upgrade PM2. PM2 is a process manager for NodeJS applications. It allows us to keep the application running in the background, restart the application automatically when it crashes, and monitor the application's resource usage. We have upgraded PM2 to accompany the new NodeJS version successfully.

We use GitLab to host our source code. After the code was ready on the GitLab repository, we issued a \lstinline{git pull} on the server's terminal to pull the latest code to the correct directory. We then installed the dependencies using \lstinline{npm install} and restarted the process with \lstinline{pm2 restart BKTrafficApi}. Figure \ref{fig:pm2_show} shows the running server process.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{assets/images/Implementation/pm2_show.png}
    \caption{The server information and the running NodeJS process.}
    \label{fig:pm2_show}
\end{figure}

\subsection{iOS App Development}
The iOS app is developed using Swift 5.9 and Xcode 15. The app is compatible with iOS 16.0 and above.

First and foremost, this app must at least offer the basic functionalities like that of the Android counterpart. This includes authentication, viewing the traffic status report, and the ability to communicate with the server. Other requirements are that the app must also be lightweight, performant, and consistent with the ongoing design of the Android app to an extent. During the development of this prototype, we have also taken into consideration the possibility of future expansion, such as adding more features and improving the user experience, as well as following Apple's best practices when it comes to iOS app development.

\subsubsection{The landing page and permission requests}
Because the UTraffic app must know the user's real-time location in order to gather GPS data and also display nearby traffic status, it is crucial that we ask the users for location permissions upon the first app launch. This is done by presenting a dialog box that asks for the user's permission to access their location. The choice is saved into \lstinline{UserDefaults}. \lstinline{UserDefaults} is an interface to the user's defaults database, where key-value pairs of data are stored persistently across launches of the app. \cite{a2019_userdefaults}. Therefore, this process will not be repeated on subsequent app launches. The onboarding process is divided into three main phases: greetings, location request, and always-on location request. They are as follows (the texts are in Vietnamese to first accommodate the Android app's design, but we are adding an option for language change in the next phase):
\begin{figure}[H]
    \centering
    \subfloat[Greetings.]{
        \includegraphics[width=0.28\linewidth]{assets/images/Implementation/onboard1.png}
        \label{fig:onboard1}
    }
    \hspace{0.5cm} % Add a horizontal space of 1cm
    \subfloat[Asking for location permission.]{
        \includegraphics[width=0.28\linewidth]{assets/images/Implementation/onboard2.png}
        \label{fig:onboard2}
    }
    \hspace{0.5cm} % Add a horizontal space of 1cm
    \subfloat[Asking for always-on location permission.]{
        \includegraphics[width=0.28\linewidth]{assets/images/Implementation/onboard3.png}
        \label{fig:onboard3}
        }
    \caption{The onboarding process of the iOS UTraffic app.}
\end{figure}

\subsubsection{Account registration and login}
We adapt most of the user interface from the Android app to the iOS app in order to provide a consistent experience of the app across platforms. The account registration and login screens are as follows:
\begin{figure}[H]
    \centering
    \subfloat[The iOS account registration view.]{
        \includegraphics[width=0.48\linewidth]{assets/images/Implementation/register_view.png}
        \label{fig:ios_register_view}
    }
    \hspace{0.5cm} % Add a horizontal space of 1cm
    \subfloat[The iOS app's login view.]{
        \includegraphics[width=0.48\linewidth]{assets/images/Implementation/login_view.png}
        \label{fig:ios_login_view}
    }
    \hspace{0.5cm} % Add a horizontal space of 1cm
    \label{fig:ios_auth_views}
    \caption{The authentication views on the iOS UTraffic app.}
\end{figure}

\subsubsection{Viewing the traffic status report}
We adopted the display logic from the Android app, where the northeast and southwest bounds of the map's visible area, along with the street level, are taken into account. However, since the Android app uses the original response data provided by the \lstinline{/get-status-v2} endpoint, using it on the iOS app means we have to develop additional classes to parse the data into the format that the iOS app can understand. We implemented the \lstinline{/get-status-v3} for this exact reason to support the iOS app better.

The home screen with the traffic status displayed is as follows:
\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{assets/images/Implementation/traffic_status_view.png}
    \caption{The home screen with the traffic status displayed.}
    \label{fig:traffic_status_view}
\end{figure}

\subsubsection{Basic bus browsing}
In this phase, we have implemented the bus list view within our iOS app. It is a view that displays all the routes within the database via the \lstinline{/routes} endpoint. 
\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{assets/images/Implementation/bus_view.png}
    \caption{The bus list view displayed in a bottom sheet.}
    \label{fig:bus_view_ios}
\end{figure}

\subsubsection{Integration with HCMUT TrafficView}
We have developed an UI to see how the elements of HCMUT TrafficView would look like on iOS. The result is as follows:

\begin{figure}
    \centering
    \includegraphics[width=0.4\textwidth]{assets/images/Implementation/hcmut_trafficview.png}
    \caption{The traffic camera view within the iOS app.}
    \label{fig:trafficview_ios}
\end{figure}




